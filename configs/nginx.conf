user www-data;
worker_processes auto;
timer_resolution 100ms;
worker_rlimit_nofile 8192;
worker_priority -5;

error_log /var/log/nginx/error.log;
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
    use epoll;
}

http {
    include mime.types;
    charset utf-8;
    default_type application/octet-stream;
    access_log /var/log/nginx/access.log;

    sendfile on;

    gzip on;
    gzip_min_length 1100;
    gzip_buffers 64 8k;
    gzip_comp_level 3;
    gzip_http_version 1.1;
    gzip_proxied any;
    gzip_types text/plain application/xml application/x-javascript text/css;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    upstream api_servers {
        server 127.0.0.1:8000;
        server 127.0.0.1:8001;
        server 127.0.0.1:8002;
        server 127.0.0.1:8003;
        server 127.0.0.1:8004;
        server 127.0.0.1:8005;
        server 127.0.0.1:8006;
        server 127.0.0.1:8007;
    }

    upstream tiler_servers {
        server 172.31.27.128:8100;
        server 172.31.27.128:8101;
        server 172.31.27.128:8102;
        server 172.31.27.128:8103;
        server 172.31.27.128:8104;
        server 172.31.27.128:8105;
        server 172.31.27.128:8106;
        server 172.31.27.128:8107;
    }

    upstream uploader_servers {
        server 127.0.0.1:8200;
        server 127.0.0.1:8201;
        server 127.0.0.1:8202;
        server 127.0.0.1:8203;
        server 127.0.0.1:8204;
        server 127.0.0.1:8205;
        server 127.0.0.1:8206;
        server 127.0.0.1:8207;
        server 127.0.0.1:8208;
        server 127.0.0.1:8209;
        server 127.0.0.1:8210;
        server 127.0.0.1:8211;
        server 127.0.0.1:8212;
        server 127.0.0.1:8213;
        server 127.0.0.1:8214;
        server 127.0.0.1:8215;
        server 127.0.0.1:8216;
        server 127.0.0.1:8217;
        server 127.0.0.1:8218;
        server 127.0.0.1:8219;
    }

    upstream admin_servers {
        server 127.0.0.1:8300;
    }

    upstream assistant_servers {
        server 127.0.0.1:8400;
    }

    upstream dicom_servers {
        server 172.31.26.190:8500;
        server 172.31.26.190:8501;
        server 172.31.26.190:8502;
        server 172.31.26.190:8503;
        server 172.31.26.190:8504;
    }

    server {
       listen 80;
       server_name dpathology.ru www.dpathology.ru;
       return 301 https://$server_name$request_uri;
    }

    server {
       listen 80;
       server_name dpathology.com www.dpathology.com;
       return 301 https://$server_name$request_uri;
    }

    server {
        modern_browser gecko 31.0;
        modern_browser safari 537.0;
        ancient_browser msie;

        #if ($http_user_agent ~ "Trident/7.0" ) {
        #    set $ancient_browser 0;
        #}

        listen 443 ssl;
        server_name dpathology.ru www.dpathology.ru dpathology.com www.dpathology.com;
        ssl_certificate /home/ubuntu/cert/dpathology.com.crt;
        ssl_certificate_key /home/ubuntu/cert/dpathology.com.key;
        resolver 172.31.0.2 valid=300s;

        rewrite ^/(.*)/$ /$1 permanent;
        server_tokens off;
        keepalive_timeout 70;

        location /robots.txt {
            alias /home/ubuntu/dpathology/robots.txt;
        }

        location @not_found {
            return 404;
        }

        location @tiler {
            uwsgi_pass tiler_servers;
            uwsgi_param Host $host;
            uwsgi_param X-Real-IP $remote_addr;
            uwsgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
            uwsgi_param X-Forwarded-Proto $http_x_forwarded_proto;
            include uwsgi_params;
        }

        location @dicom {
            proxy_pass http://dicom_servers;
            proxy_read_timeout 300;
            include proxy_params;
        }

        location ~ ^/dicom/(.*) {
            access_log off;
            proxy_intercept_errors on;
            proxy_hide_header x-amz-id-2;
            proxy_hide_header x-amz-request-id;
            proxy_read_timeout 300;
            recursive_error_pages on;
            error_page 403 = @dicom;
            error_page 404 = @dicom;
            proxy_pass https://s3.eu-central-1.amazonaws.com/dpathology/$1;
        }

        location ~ ^/files/(.*) {
            access_log off;
            proxy_intercept_errors on;
            proxy_hide_header x-amz-id-2;
            proxy_hide_header x-amz-request-id;
            recursive_error_pages on;
            error_page 403 = @not_found;
            proxy_pass https://s3.eu-central-1.amazonaws.com/dpathology/$1;
        }

        location /upload {
            client_max_body_size 100m;
            uwsgi_request_buffering off;
            uwsgi_pass uploader_servers;
            uwsgi_param Host $host;
            uwsgi_param X-Real-IP $remote_addr;
            uwsgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
            uwsgi_param X-Forwarded-Proto $http_x_forwarded_proto;
            include uwsgi_params;
        }

        location ~ ^/tiles/(.*) {
            access_log off;
            proxy_intercept_errors on;
            proxy_hide_header x-amz-id-2;
            proxy_hide_header x-amz-request-id;
            recursive_error_pages on;
            error_page 403 = @tiler;
            error_page 404 = @tiler;
            proxy_pass https://s3.eu-central-1.amazonaws.com/dpathology/$1;
        }

        location /api/ {
            rewrite ^/api/(.*)$ /$1 break;
            uwsgi_pass api_servers;
            uwsgi_param Host $host;
            uwsgi_param X-Real-IP $remote_addr;
            uwsgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
            uwsgi_param X-Forwarded-Proto $http_x_forwarded_proto;
            include uwsgi_params;
        }

        location /static/ {
            access_log off;
            gzip_static on;
            alias /home/ubuntu/dpathology/frontend/public/;
        }

        location /ws/ {
            proxy_pass http://127.0.0.1:5000;
            proxy_read_timeout 3600s;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        location /ws-audio/ {
            proxy_pass http://127.0.0.1:5005;
            proxy_read_timeout 3600s;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        location / {
            gzip_static on;
            root /home/ubuntu/dpathology/frontend/public;

            if ($ancient_browser) {
                rewrite ^/(.*)$ /ancient.html break;
            }

            rewrite ^/(.*)$ /index.html break;
        }

        # error_page 404 /404.html;
        # location = /404.html {
        #     root /var/nginx/html;
        # }

        # error_page 500 502 503 504 /50x.html;
        # location = /50x.html {
        #     root /var/nginx/html;
        # }
    }

    server {
        listen 9999 ssl;
        server_name dpathology.ru www.dpathology.ru dpathology.com www.dpathology.com;
        ssl_certificate /home/ubuntu/cert/dpathology.com.crt;
        ssl_certificate_key /home/ubuntu/cert/dpathology.com.key;
        resolver 172.31.0.2 valid=300s;

        rewrite ^/(.*)/$ /$1 permanent;
        server_tokens off;

        keepalive_timeout 70;

        location /robots.txt {
            alias /home/ubuntu/dpathology/robots.txt;
        }

        location @not_found {
            return 404;
        }

        location @tiler {
            uwsgi_pass tiler_servers;
            uwsgi_param Host $host;
            uwsgi_param X-Real-IP $remote_addr;
            uwsgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
            uwsgi_param X-Forwarded-Proto $http_x_forwarded_proto;
            include uwsgi_params;
        }

        location ~ ^/files/(.*) {
            access_log off;
            proxy_intercept_errors on;
            proxy_hide_header x-amz-id-2;
            proxy_hide_header x-amz-request-id;
            recursive_error_pages on;
            error_page 403 = @not_found;
            proxy_pass https://s3.eu-central-1.amazonaws.com/dpathology/$1;
        }

        location ~ ^/tiles/(.*) {
            access_log off;
            proxy_intercept_errors on;
            proxy_hide_header x-amz-id-2;
            proxy_hide_header x-amz-request-id;
            recursive_error_pages on;
            error_page 403 = @tiler;
            error_page 404 = @tiler;
            proxy_pass https://s3.eu-central-1.amazonaws.com/dpathology/$1;
        }

        location /static/ {
            access_log off;
            gzip_static on;
            alias /home/ubuntu/dpathology/backend/static/;
        }

        location / {
            client_max_body_size 100m;
            uwsgi_pass admin_servers;
            uwsgi_param Host $host;
            uwsgi_param X-Real-IP $remote_addr;
            uwsgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
            uwsgi_param X-Forwarded-Proto $http_x_forwarded_proto;
            include uwsgi_params;
        }
    }

    server {
        listen 9090 ssl;
        server_name dpathology.ru www.dpathology.ru dpathology.com www.dpathology.com;
        ssl_certificate /home/ubuntu/cert/dpathology.com.crt;
        ssl_certificate_key /home/ubuntu/cert/dpathology.com.key;
        resolver 172.31.0.2 valid=300s;

        rewrite ^/(.*)/$ /$1 permanent;
        server_tokens off;

        keepalive_timeout 70;

        location /robots.txt {
            alias /home/ubuntu/dpathology/robots.txt;
        }

        location @not_found {
            return 404;
        }

        location @tiler {
            uwsgi_pass tiler_servers;
            uwsgi_param Host $host;
            uwsgi_param X-Real-IP $remote_addr;
            uwsgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
            uwsgi_param X-Forwarded-Proto $http_x_forwarded_proto;
            include uwsgi_params;
        }

        location ~ ^/files/(.*) {
            access_log off;
            proxy_intercept_errors on;
            proxy_hide_header x-amz-id-2;
            proxy_hide_header x-amz-request-id;
            recursive_error_pages on;
            error_page 403 = @not_found;
            proxy_pass https://s3.eu-central-1.amazonaws.com/dpathology/$1;
        }

        location ~ ^/tiles/(.*) {
            access_log off;
            proxy_intercept_errors on;
            proxy_hide_header x-amz-id-2;
            proxy_hide_header x-amz-request-id;
            recursive_error_pages on;
            error_page 403 = @tiler;
            error_page 404 = @tiler;
            proxy_pass https://s3.eu-central-1.amazonaws.com/dpathology/$1;
        }

        location /static/ {
            access_log off;
            gzip_static on;
            alias /home/ubuntu/dpathology/backend/static/;
        }

        location / {
            client_max_body_size 100m;
            uwsgi_pass assistant_servers;
            uwsgi_param Host $host;
            uwsgi_param X-Real-IP $remote_addr;
            uwsgi_param X-Forwarded-For $proxy_add_x_forwarded_for;
            uwsgi_param X-Forwarded-Proto $http_x_forwarded_proto;
            include uwsgi_params;
        }
    }
}
